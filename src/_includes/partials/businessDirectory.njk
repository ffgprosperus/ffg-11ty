{%- from "components/component.njk" import component -%}

<div class="flex flex-col items-center justify-between py-20  bg-gray-100">
  {% set args = {'data': {'headerText': 'Explore Our Network'} } %}
  {{ component('partials/sectionHeader.njk', args) }}


  <div class="inline-block w-4/5 self-center mt-5">
    <div id="map" style="height: 600px; width: 100%;"></div>
  </div>
</div>


{{ collections.maps | createMapsJson }}

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

<script>
function loadDoc() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
       if (this.readyState == 4 && this.status == 200) {
           initializeMap(JSON.parse(this.responseText));
       }
    };
    xhttp.open("GET", "businessInfo.json", true);
    xhttp.send();
}

var map;

function initializeMap(directoryCollection) {
    locations = []

    directoryCollection.forEach(location => {
      var businessLocation = {};
      businessLocation.title = location.name;
      businessLocation.latitude = location.latitude;
      businessLocation.longitude = location.longitude;
      businessLocation.email = location.email;
      businessLocation.mobile = location.mobile;
      businessLocation.address = location.address;
      locations.push(businessLocation);
    })
    var mapOptions = {
      zoom: 10,
      center: new google.maps.LatLng(0, 0)
    };
    var map = new google.maps.Map(document.getElementById('map'), mapOptions);

    var bounds = new google.maps.LatLngBounds();
    // Create nice, customised pop-up boxes, to appear when the marker is clicked on
    var infowindow = new google.maps.InfoWindow({
      content: "Content String"
    });
    for (var i = 0; i < locations.length; i++) {
      var new_marker = createMarker(map, locations[i], infowindow);
      bounds.extend(new_marker.position);
    }
    map.setOptions({ styles: [ { featureType: "poi", stylers: [{visibility: "off"}] } ] })
    map.fitBounds(bounds);

}

function createMarker(map, location, infowindow) {
  var position = {
    lat: parseFloat(location.latitude),
    lng: parseFloat(location.longitude)
  };
  var marker = new google.maps.Marker({
    position: position,
    map: map,
    title: location.name,
  });
   google.maps.event.addListener(marker, 'click', function() {
     infowindow.setContent('<div>'+
     '<p class="flex justify-center mb-2"><strong>' + location.title + '</strong></p>' +
     '<p><strong>Address: </strong>' + location.address + '</p>' +
     '<p><strong>Phone: </strong>' + location.mobile + '</p>' +
     '<p><strong>Email: </strong>' + location.email + '</p></div>');
     infowindow.open(map, marker);
  })
  return marker
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfpU4ZBRpxXM65E3TDMo2uGPz_yMfpCew&callback=loadDoc" async defer/>
